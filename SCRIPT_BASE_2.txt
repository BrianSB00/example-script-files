-- USE THIS SCRIPT WHEN THE SELECT INCLUDES THE COLUMN NAMES INSTEAD OF *
-- Descripción: Este script consulta el historico de tarifas para el año 2023.
SET SERVEROUTPUT ON SIZE UNLIMITED;  -- Obligatorio para visualizar la salida
 
DECLARE    
    -- TYPE DECLARATION
    TYPE historico_costos_rec IS RECORD (
        PROVEEDOR                   NUMBER(10),
        NOMBRE_PROVEEDOR            VARCHAR2(500),
        NIT_PROVEEDOR               VARCHAR2(200),
        DESC_TIPO_PROVEEDOR         VARCHAR2(200),
        TIPO_PROVEEDOR              NUMBER(2),
        ESTADO_PROVEEDOR            VARCHAR2(20),
        NOMBRE_DEPARTAMENTO         VARCHAR2(100),
        NOMBRE_CIUDAD               VARCHAR2(100),
        DESC_PLAN                   VARCHAR2(200),
        CODIGO_PLAN                 NUMBER(3),
        PROGRAMA                    VARCHAR2(100),
        DESC_PROGRAMA               VARCHAR2(500),
        CODIGO_ACTIVIDAD_PROGRAMA   VARCHAR2(50),
        DESC_ACT_PROGRAMA           VARCHAR2(200),
        UNIDAD_MEDIDA               VARCHAR2(50),
        ACTIVIDAD_CAPACITACION      VARCHAR2(1),
        ACTIVIDAD_ASESORIA          VARCHAR2(1),
        ACTIVIDAD_ASISTENCIA        VARCHAR2(1),
        ACTIVIDAD_SERVICIO          VARCHAR2(1),
        ACTIVIDAD_MATERIAL_DIDACTICO VARCHAR2(1),
        VALOR_TARIFA_ACTIVIDAD      NUMBER(18, 3),
        VALOR_COSTO_ACTIVIDAD       NUMBER(18, 3),
        FECHA_VIGENCIA_DESDE        DATE,
        FECHA_VIGENCIA_HASTA        DATE,
        REQUIERE_AUTORIZACION       VARCHAR2(1),
        ESTADO_ACTIVIDAD_PROGRAMA   VARCHAR2(20)
    );
    
    TYPE historico_costos_tab IS TABLE OF historico_costos_rec;
    v_historico_costos historico_costos_tab;

BEGIN             

    -- QUERY EXAMPLE   
    SELECT  AP.AEN_CODIGO PROVEEDOR,
            ARP.AEN_RAZONSOC NOMBRE_PROVEEDOR,
            ARP.AEN_IDENTIFIC NIT_PROVEEDOR,
            (SELECT B.RV_MEANING FROM PREVENCION.CG_REF_CODES B WHERE B.RV_DOMAIN = 'TIPO_PROVEEDOR' AND B.RV_CREATE_BY = 'PREVENCION' AND B.RV_LOW_VALUE = ARP.AEN_TIPO) DESC_TIPO_PROVEEDOR,
            ARP.AEN_TIPO TIPO_PROVEEDOR,
            DECODE(ARP.AEN_ESTADO, 1, 'ACTIVO', 'INACTIVO') ESTADO_PROVEEDOR,
            (SELECT NOMBRE FROM SIP_DIVISION_POLITICAS_MVW WHERE NIV_CODIGO = 'DEP' AND CODIGO = ARP.AEN_DEPTO) NOMBRE_DEPARTAMENTO,
            (SELECT NOMBRE FROM SIP_DIVISION_POLITICAS_MVW WHERE NIV_CODIGO = 'MUN' AND CODIGO = ARP.AEN_CIUDAD) NOMBRE_CIUDAD,
            (SELECT DESCRIPCION || ' - ' || SIGLA_PLAN FROM PLAN_PREVENCION WHERE CODIGO_PLAN = ACTP.CODIGO_PLAN) DESC_PLAN,
            ACTP.CODIGO_PLAN CODIGO_PLAN,
            SUBSTR(ACTP.CODIGO_ACTIVIDAD_PROGRAMA, 1, INSTR(ACTP.CODIGO_ACTIVIDAD_PROGRAMA, '.') - 1) PROGRAMA,
            TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE((SELECT A.DESCRIPCION FROM ACTIVIDAD_PROGRAMA A WHERE A.CODIGO_ACTIVIDAD_PROGRAMA = SUBSTR(ACTP.CODIGO_ACTIVIDAD_PROGRAMA, 1, INSTR(ACTP.CODIGO_ACTIVIDAD_PROGRAMA, '.') - 1)), CHR(13), ''), CHR(10), ''), CHR(59), '-'), CHR(34), ''), CHR(9), '')) DESC_PROGRAMA,
            ACTP.CODIGO_ACTIVIDAD_PROGRAMA CODIGO_ACTIVIDAD_PROGRAMA,
            TRIM(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ACTP.DESCRIPCION, CHR(13), ''), CHR(10), ''), CHR(59), '-'), CHR(34), ''), CHR(9), '')) DESC_ACT_PROGRAMA,
            ACTP.UNIDAD_MEDIDA UNIDAD_MEDIDA,
            ACTP.ACTIVIDAD_CAPACITACION ACTIVIDAD_CAPACITACION,
            ACTP.ACTIVIDAD_ASESORIA ACTIVIDAD_ASESORIA,
            ACTP.ACTIVIDAD_ASISTENCIA ACTIVIDAD_ASISTENCIA,
            ACTP.ACTIVIDAD_SERVICIO ACTIVIDAD_SERVICIO,
            ACTP.ACTIVIDAD_MATERIAL_DIDACTICO ACTIVIDAD_MATERIAL_DIDACTICO,
            HAP.VALOR_TARIFA VALOR_TARIFA_ACTIVIDAD,
            HAP.VALOR_COSTO VALOR_COSTO_ACTIVIDAD,
            HAP.FECHA_VIGENCIA_DESDE FECHA_VIGENCIA_DESDE,
            HAP.FECHA_VIGENCIA_HASTA FECHA_VIGENCIA_HASTA,
            AP.REQUIERE_AUTORIZACION REQUIERE_AUTORIZACION,
            ACTP.ESTADO_ACTIVIDAD_PROGRAMA ESTADO_ACTIVIDAD_PROGRAMA
    BULK COLLECT INTO v_historico_costos
    FROM HISTORICO_ACTIVIDAD_PROVEEDOR HAP,
         ACTIVIDAD_PROVEEDOR           AP,
         ACTIVIDAD_PROGRAMA            ACTP,
         SIP_ARPENTIDADES_MVW          ARP
    WHERE HAP.SECUENCIA_ACTIVIDAD_PROGRAMA = AP.SECUENCIA_ACTIVIDAD_PROGRAMA
    AND HAP.AEN_CODIGO = AP.AEN_CODIGO
    AND AP.AEN_CODIGO = ARP.AEN_CODIGO
    AND ACTP.SECUENCIA_ACTIVIDAD_PROGRAMA = AP.SECUENCIA_ACTIVIDAD_PROGRAMA
    AND ARP.AEN_ESTADO = 1
    AND TO_CHAR(HAP.FECHA_VIGENCIA_DESDE, 'YYYY') = '2023'
    ORDER BY PROVEEDOR
    OFFSET 380000 ROWS FETCH NEXT 80000 ROWS ONLY;
    
    -- COLUMNS NAMES
    DBMS_OUTPUT.PUT_LINE('PROVEEDOR^NOMBRE_PROVEEDOR^NIT_PROVEEDOR^DESC_TIPO_PROVEEDOR^TIPO_PROVEEDOR^ESTADO_PROVEEDOR^NOMBRE_DEPARTAMENTO^NOMBRE_CIUDAD^DESC_PLAN^CODIGO_PLAN^PROGRAMA^DESC_PROGRAMA^CODIGO_ACTIVIDAD_PROGRAMA^DESC_ACT_PROGRAMA^UNIDAD_MEDIDA^ACTIVIDAD_CAPACITACION^ACTIVIDAD_ASESORIA^ACTIVIDAD_ASISTENCIA^ACTIVIDAD_SERVICIO^ACTIVIDAD_MATERIAL_DIDACTICO^VALOR_TARIFA_ACTIVIDAD^VALOR_COSTO_ACTIVIDAD^FECHA_VIGENCIA_DESDE^FECHA_VIGENCIA_HASTA^REQUIERE_AUTORIZACION^ESTADO_ACTIVIDAD_PROGRAMA');

    -- QUERY VALUES
    FOR i IN 1 .. v_historico_costos.COUNT LOOP   

        DBMS_OUTPUT.PUT_LINE(
            v_historico_costos(i).PROVEEDOR || '^' ||
            v_historico_costos(i).NOMBRE_PROVEEDOR || '^' ||
            v_historico_costos(i).NIT_PROVEEDOR || '^' ||
            v_historico_costos(i).DESC_TIPO_PROVEEDOR || '^' ||
            v_historico_costos(i).TIPO_PROVEEDOR || '^' ||
            v_historico_costos(i).ESTADO_PROVEEDOR || '^' ||
            v_historico_costos(i).NOMBRE_DEPARTAMENTO || '^' ||
            v_historico_costos(i).NOMBRE_CIUDAD || '^' ||
            v_historico_costos(i).DESC_PLAN || '^' ||
            v_historico_costos(i).CODIGO_PLAN || '^' ||
            v_historico_costos(i).PROGRAMA || '^' ||
            v_historico_costos(i).DESC_PROGRAMA || '^' ||
            v_historico_costos(i).CODIGO_ACTIVIDAD_PROGRAMA || '^' ||
            v_historico_costos(i).DESC_ACT_PROGRAMA || '^' ||
            v_historico_costos(i).UNIDAD_MEDIDA || '^' ||
            v_historico_costos(i).ACTIVIDAD_CAPACITACION || '^' ||
            v_historico_costos(i).ACTIVIDAD_ASESORIA || '^' ||
            v_historico_costos(i).ACTIVIDAD_ASISTENCIA || '^' ||
            v_historico_costos(i).ACTIVIDAD_SERVICIO || '^' ||
            v_historico_costos(i).ACTIVIDAD_MATERIAL_DIDACTICO || '^' ||
            v_historico_costos(i).VALOR_TARIFA_ACTIVIDAD || '^' ||
            v_historico_costos(i).VALOR_COSTO_ACTIVIDAD || '^' ||
            TO_CHAR(v_historico_costos(i).FECHA_VIGENCIA_DESDE, 'YYYY-MM-DD') || '^' ||
            TO_CHAR(v_historico_costos(i).FECHA_VIGENCIA_HASTA, 'YYYY-MM-DD') || '^' ||
            v_historico_costos(i).REQUIERE_AUTORIZACION || '^' ||
            v_historico_costos(i).ESTADO_ACTIVIDAD_PROGRAMA
        );   

    END LOOP;     
    
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error durante la consulta: ' || SQLERRM);
END;
/
